# 预启动容器

基于`kubernetes v1.18.6`

## 概述

`kubelet`通过以下四个步骤，来启动`pod`容器：

1. 拉取镜像
2. 创建容器
3. 启动容器
4. 执行容器启动完成钩子

其中`创建容器`又分为四个子步骤：

1. 设置容器重启次数
2. 生成创建容器所需配置
3. 创建容器
4. 预启动容器
5. 配置容器引用

本文主要解析`创建容器/预启动容器`阶段`kubelet`所做工作，首先我们先看下`预启动容器`阶段的代码逻辑

> 预启动容器入口函数源码

`kubernetes\pkg\kubelet\kuberuntime\kuberuntime_container.go`
```go
func (m *kubeGenericRuntimeManager) startContainer(podSandboxID string, podSandboxConfig *runtimeapi.PodSandboxConfig, spec *startSpec, pod *v1.Pod, podStatus *kubecontainer.PodStatus, pullSecrets []v1.Secret, podIP string, podIPs []string) (string, error) {
...
    containerID, err := m.runtimeService.CreateContainer(podSandboxID, containerConfig, podSandboxConfig)
	if err != nil {
		s, _ := grpcstatus.FromError(err)
		m.recordContainerEvent(pod, container, containerID, v1.EventTypeWarning, events.FailedToCreateContainer, "Error: %v", s.Message())
		return s.Message(), ErrCreateContainer
	}
	err = m.internalLifecycle.PreStartContainer(pod, container, containerID)
	if err != nil {
		s, _ := grpcstatus.FromError(err)
		m.recordContainerEvent(pod, container, containerID, v1.EventTypeWarning, events.FailedToStartContainer, "Internal PreStartContainer hook failed: %v", s.Message())
		return s.Message(), ErrPreStartHook
	}
	m.recordContainerEvent(pod, container, containerID, v1.EventTypeNormal, events.CreatedContainer, fmt.Sprintf("Created container %s", container.Name))
...
```

透过源码我们发现，`m.internalLifecycle.PreStartContainer(pod, container, containerID)`为`预启动容器`步骤主要逻辑

该阶段主要设置`pod`容器的`cpu`管理策略与拓扑管理策略。

其中`cpu`管理策略分为:

- `none`: 默认策略，表示现有的调度行为。
- `static`: 该策略针对具有整数型`CPU requests`的`Guaranteed Pod`，它允许该类`Pod`中的容器访问节点上的独占`CPU`资源。
这种独占性是使用[cpuset cgroup 控制器](https://www.kernel.org/doc/Documentation/cgroup-v1/cpusets.txt) 来实现的

关于`cpu`管理策略请参考[控制节点上的 CPU 管理策略](https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-management-policies/)

关于拓扑管理策略请参考[控制节点上的拓扑管理策略](https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/)

对应源码实现:

```go
func (i *internalContainerLifecycleImpl) PreStartContainer(pod *v1.Pod, container *v1.Container, containerID string) error {
	if i.cpuManager != nil {
		err := i.cpuManager.AddContainer(pod, container, containerID)
		if err != nil {
			return err
		}
	}
	if utilfeature.DefaultFeatureGate.Enabled(kubefeatures.TopologyManager) {
		err := i.topologyManager.AddContainer(pod, containerID)
		if err != nil {
			return err
		}
	}
	return nil
}
```